#!/usr/bin/env node
"use strict";

const fs = require("fs");
const path = require("path");
const { check, parseAndAnalyze, formatDiag, FrontendError } = require("../src/frontend");
const { buildIR, printIR } = require("../src/ir");

function usage() {
  console.error("Usage:");
  console.error("  protoscriptc --check <file.pts>");
  console.error("  protoscriptc --emit-ir <file.pts>");
  process.exit(2);
}

const args = process.argv.slice(2);
if (args.length !== 2) usage();

const mode = args[0];
const file = args[1];

if (mode !== "--check" && mode !== "--emit-ir") {
  console.error("error: unsupported mode");
  process.exit(2);
}

const full = path.resolve(file);
let src = "";
try {
  src = fs.readFileSync(full, "utf8");
} catch (e) {
  console.error(`error: cannot read file '${file}'`);
  process.exit(2);
}

try {
  if (mode === "--check") {
    const diags = check(file, src);
    if (diags.length > 0) {
      for (const d of diags) console.error(formatDiag(d));
      process.exit(1);
    }
    process.exit(0);
  }

  const { ast, diags } = parseAndAnalyze(file, src);
  if (diags.length > 0) {
    for (const d of diags) console.error(formatDiag(d));
    process.exit(1);
  }
  const ir = buildIR(ast);
  process.stdout.write(printIR(ir));
  process.exit(0);
} catch (e) {
  if (e instanceof FrontendError && e.diag) {
    console.error(formatDiag(e.diag));
    process.exit(1);
  }
  console.error(`internal error: ${e && e.message ? e.message : String(e)}`);
  process.exit(1);
}
